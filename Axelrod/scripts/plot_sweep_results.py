#!/usr/bin/env python3
"""
Plot 2x2 subplots for each parameter sweep with key metrics.
Reads CSV files generated by main.cpp and creates comprehensive visualizations.

Usage:
  python scripts/plot_sweep_results.py --data-dir data --out-dir figures

If matplotlib is not installed: `python -m pip install matplotlib numpy pandas`
"""
import argparse
import os
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt


def read_sweep_csv(filepath):
    """Read a CSV file and return a DataFrame."""
    try:
        return pd.read_csv(filepath)
    except FileNotFoundError:
        print(f"Warning: file {filepath} not found")
        return None


def create_2x2_subplot(param_name, param_values, df, out_dir):
    """Create a 2x2 subplot figure for a sweep parameter."""
    fig, axes = plt.subplots(2, 2, figsize=(14, 10))
    fig.suptitle(f'Parameter Sweep: {param_name.replace("_", " ").title()}', 
                 fontsize=16, fontweight='bold')
    
    # Flatten axes array for easier iteration
    axes = axes.flatten()
    
    # Plot 1: Number of distinct cultures
    axes[0].plot(param_values, df['num_cultures'], marker='o', linewidth=2, markersize=8, color='steelblue')
    axes[0].set_xlabel(param_name.replace("_", " ").title())
    axes[0].set_ylabel('Number of Distinct Cultures')
    axes[0].set_title('Culture Fragmentation')
    axes[0].grid(True, linestyle='--', alpha=0.5)
    axes[0].set_facecolor('#f8f9fa')
    
    # Plot 2: Largest culture fraction
    axes[1].plot(param_values, df['largest_culture_fraction'], marker='s', linewidth=2, 
                markersize=8, color='darkgreen')
    axes[1].set_xlabel(param_name.replace("_", " ").title())
    axes[1].set_ylabel('Largest Culture Size (Fraction)')
    axes[1].set_title('Convergence to Single Culture')
    axes[1].grid(True, linestyle='--', alpha=0.5)
    axes[1].set_facecolor('#f8f9fa')
    
    # Plot 3: Entropy
    axes[2].plot(param_values, df['entropy'], marker='^', linewidth=2, markersize=8, color='darkorange')
    axes[2].set_xlabel(param_name.replace("_", " ").title())
    axes[2].set_ylabel('Entropy')
    axes[2].set_title('Cultural Diversity (Entropy)')
    axes[2].grid(True, linestyle='--', alpha=0.5)
    axes[2].set_facecolor('#f8f9fa')
    
    # Plot 4: Edge homophily
    axes[3].plot(param_values, df['edge_homophily'], marker='D', linewidth=2, markersize=8, color='crimson')
    axes[3].set_xlabel(param_name.replace("_", " ").title())
    axes[3].set_ylabel('Edge Homophily')
    axes[3].set_title('Network Assortivity by Culture')
    axes[3].grid(True, linestyle='--', alpha=0.5)
    axes[3].set_facecolor('#f8f9fa')
    
    plt.tight_layout()
    
    # Save figure
    safe_name = param_name.replace(" ", "_").lower()
    out_path = os.path.join(out_dir, f'sweep_{safe_name}.png')
    plt.savefig(out_path, dpi=300, bbox_inches='tight')
    print(f'Saved {out_path}')
    plt.close()


def create_comparison_figure(out_dir):
    """Create a comparison figure showing all sweeps side by side."""
    
    sweep_files = [
        ('data/sweep_neighbors_per_node.csv', 'Neighbors per Node'),
        ('data/sweep_rewiring_prob.csv', 'Rewiring Probability'),
        ('data/sweep_num_features.csv', 'Number of Features'),
        ('data/sweep_feature_dim.csv', 'Feature Dimension'),
    ]
    
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    fig.suptitle('Comparison of All Parameter Sweeps', fontsize=16, fontweight='bold')
    axes = axes.flatten()
    
    for idx, (filepath, label) in enumerate(sweep_files):
        df = read_sweep_csv(filepath)
        if df is None:
            continue
            
        # Determine x-axis values
        if 'neighbors' in label.lower():
            x_vals = df['param_value'].values
            xlabel = 'Neighbors per Node'
        elif 'rewiring' in label.lower():
            x_vals = df['param_value'].values
            xlabel = 'Rewiring Probability'
        elif 'features' in label.lower() and 'dimension' not in label.lower():
            x_vals = df['param_value'].values
            xlabel = 'Number of Features'
        else:
            x_vals = df['param_value'].values
            xlabel = 'Feature Dimension'
        
        # Plot largest culture fraction
        axes[idx].plot(x_vals, df['largest_culture_fraction'], marker='o', linewidth=2.5, 
                      markersize=10, label='Largest Culture', color='darkgreen')
        ax2 = axes[idx].twinx()
        ax2.plot(x_vals, df['num_cultures'], marker='s', linewidth=2.5, markersize=10, 
                label='Num Cultures', color='steelblue', linestyle='--')
        
        axes[idx].set_xlabel(xlabel, fontweight='bold')
        axes[idx].set_ylabel('Largest Culture Fraction', fontweight='bold', color='darkgreen')
        ax2.set_ylabel('Number of Cultures', fontweight='bold', color='steelblue')
        axes[idx].set_title(label, fontweight='bold')
        axes[idx].grid(True, linestyle='--', alpha=0.5)
        axes[idx].set_facecolor('#f8f9fa')
        axes[idx].tick_params(axis='y', labelcolor='darkgreen')
        ax2.tick_params(axis='y', labelcolor='steelblue')
        
        # Add legends
        lines1, labels1 = axes[idx].get_legend_handles_labels()
        lines2, labels2 = ax2.get_legend_handles_labels()
        axes[idx].legend(lines1 + lines2, labels1 + labels2, loc='upper left')
    
    plt.tight_layout()
    out_path = os.path.join(out_dir, 'sweep_comparison.png')
    plt.savefig(out_path, dpi=300, bbox_inches='tight')
    print(f'Saved {out_path}')
    plt.close()


def main():
    p = argparse.ArgumentParser(
        description='Plot 2x2 subplots for parameter sweep results'
    )
    p.add_argument('--data-dir', default='data', help='Directory with sweep CSV files')
    p.add_argument('--out-dir', default='figures', help='Output directory for PNG files')
    p.add_argument('--show', action='store_true', help='Show figures interactively')
    args = p.parse_args()

    os.makedirs(args.out_dir, exist_ok=True)

    # List of sweeps to plot
    sweeps = [
        ('data/sweep_neighbors_per_node.csv', 'Neighbors per Node'),
        ('data/sweep_rewiring_prob.csv', 'Rewiring Probability'),
        ('data/sweep_num_features.csv', 'Number of Features'),
        ('data/sweep_feature_dim.csv', 'Feature Dimension'),
    ]

    print("Creating 2x2 sweep plots...\n")

    for filepath, param_name in sweeps:
        df = read_sweep_csv(filepath)
        if df is None:
            continue

        # Extract parameter values
        if 'rewiring' in param_name.lower():
            param_values = df['param_value'].values
        else:
            param_values = df['param_value'].values

        create_2x2_subplot(param_name, param_values, df, args.out_dir)

    # Create comparison figure
    print("\nCreating comparison figure...")
    create_comparison_figure(args.out_dir)

    print("\nAll plots generated successfully!")
    
    if args.show:
        plt.show()


if __name__ == '__main__':
    main()
